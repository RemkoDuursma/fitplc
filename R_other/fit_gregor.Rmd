---
title: "Fitting near-linear PLC curves"
author: "Remko Duursma"
date: "9 May 2017"
output: 
  html_document:
    theme: flatly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


With the `fitplc` package, when fitting conductance vs. water potential, it is necessary to specify the maximum conductance (K~max~) because the fitting proceeds on relative values of conductance (or percent loss conductivity). This is done either by specifying a threshold water potential (`WP_Kmax`), in which case K~max~ is calculated from the conductance data below this treshold, or by specifying K~max~ directly. The use of `WP_Kmax` is usually preferred and causes no issues when conductance vs. water potential shows a highly sigmoidal relationship.

However for data that are more linear in shape, the choice of `WP_Kmax` greatly affects the estimate of P~50~ (or generally P~x~). It turns out that it is also not possible to find a K~max~ that gives the best fit overall (this is the case for both sigmoidal and Weibull models - I won't get into the details here).

# Non-parametric fitting

To resolve this problem, I fit curves of conductance vs. water potential with a non-parametric regression smoother (a loess model), and estimate P~50~ as the water potential at which conductance has reached 50% of the maximum, where the maximum is estimated as the fitted conductance at the least negative water potential in the dataset. This differs from the previous implementation in that P~50~ was expressed relative to conductance at *zero water potential*. For highly sigmoidal data, the two will be the same, but not so for more linear data.


# Example data

I use Gregor's data on 17 species (though the file name indicates 13 species; the Species column has 17 unique values).

```{r}
greg <- read.csv("gregor_13_species_set1.csv")

library(ggplot2)
ggplot(greg, aes(MPa,K)) + geom_point() + facet_wrap(~Species)
```

As you can see, `K` versus water potential `MPa` is quite linear.

For comparison, we can fit a loess model with specifying the threshold water potential.

```{r, message=FALSE}
# Subset, one species
dat <- subset(greg, Species == "MM")

library(fitplc)

fit1 <- fitcond(dat, model="loess", WP_Kmax=1)
plot(fit1)
coef(fit1)
```

When we rescale the estimated Px by the conductance at the maximum water potential, we don't have to specify the threshold but have to set `rescale_Px=TRUE`


```{r}
fit2 <- fitcond(dat, model="loes", rescale_Px=TRUE)
plot(fit2)
coef(fit2)
```


# P50 estimates {.tabset}

Below you can click through the fits for the various species in the dataset.
To fit all species at once, we can now use `fitconds` without specifying any arbitrary arguments.

```{r}
allfits <- fitconds(greg, "Species", rescale_Px=TRUE, model="loess")
```

Note we can get a warning when the bootstrap finds a significant number of missing values in the Px from the fitted curves - this happens when the Px is not actually reached (always) for a particular dataset. Note in this case the missing value for the upper confidence limit for the `ME` species.

The following table summarizes the estimated P50 with confidence intervals.

```{r, echo=FALSE}
p <- coef(allfits)
p <- subset(p, Parameter != "SX", select = -Parameter)
names(p)[1:2] <- c("Species","P50")
knitr::kable(p)
```

```{r, echo=FALSE}
plotit <- function(sp){
  plot(allfits[[sp]])
  legend("topright", paste("species : ", sp), bty='n')
}
```

Click on the species name to see the fit for that species.

## DE

```{r}
plotit("DE")
```

## DI

```{r}
plotit("DI")
```

## GL

```{r}
plotit("GL")
```

## IA

```{r}
plotit("IA")
```

## ME

```{r}
plotit("ME")
```

## ME-n

```{r}
plotit("ME-n")
```

## MI

```{r}
plotit("MI")
```

## MM

```{r}
plotit("MM")
```

## MU

```{r}
plotit("MU")
```

## OB

```{r}
plotit("OB")
```

## PN

```{r}
plotit("PN")
```

## PO

```{r}
plotit("PO")
```

## PS

```{r}
plotit("PS")
```

## RE

```{r}
plotit("RE")
```

## RR

```{r}
plotit("RR")
```

## RR-1

```{r}
plotit("RR-1")
```

## TR

```{r}
plotit("TR")
```










